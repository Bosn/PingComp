<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PingComp · Enrich</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand"><img src="/logo.svg" class="logo" alt="logo"><div><h1>Enrichment Queue</h1><p>队列、重试与状态管理</p></div></div>
    <div style="display:flex;gap:8px"><a class="btn" href="/">Leads</a><a class="btn" href="/dashboard">Dashboard</a></div>
  </div>

  <div class="edit-grid">
    <div class="card" style="padding:14px"><div class="muted">Pending</div><h2><%= stats.pending || 0 %></h2></div>
    <div class="card" style="padding:14px"><div class="muted">Running</div><h2><%= stats.running || 0 %></h2></div>
    <div class="card" style="padding:14px"><div class="muted">Done</div><h2><%= stats.done_count || 0 %></h2></div>
    <div class="card" style="padding:14px"><div class="muted">Failed</div><h2><%= stats.failed || 0 %></h2></div>
  </div>

  <div class="card" style="padding:14px;margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <form method="post" action="/enrich/enqueue" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <input class="input" style="min-width:420px" name="ids" placeholder="输入要入队的lead ids，例如 12,45,99">
      <button class="btn" type="submit">入队</button>
    </form>
    <form method="post" action="/enrich/run"><button class="btn primary" type="submit">执行一轮（20条）</button></form>
  </div>

  <div class="card table-wrap" style="margin-top:14px;">
    <table>
      <tr><th>QueueID</th><th>LeadID</th><th>Name</th><th>Status</th><th>Attempts</th><th>Lead Enrich Status</th><th>Error</th><th>Updated</th><th>Action</th></tr>
      <% rows.forEach(r => { %>
      <tr>
        <td><%= r.id %></td><td><%= r.lead_id %></td><td><%= r.name || '' %></td>
        <td><%= r.status %></td><td><%= r.attempts %></td><td><%= r.enrich_status || '' %></td>
        <td><%= r.last_error || '' %></td><td><%= r.updated_at %></td>
        <td>
          <% if (r.status === 'failed') { %>
            <form method="post" action="/enrich/retry/<%= r.id %>"><button class="btn" type="submit">重试</button></form>
          <% } %>
        </td>
      </tr>
      <% }) %>
    </table>
  </div>
</div>
</body>
</html>
